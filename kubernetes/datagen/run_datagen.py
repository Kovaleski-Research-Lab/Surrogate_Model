# Import: Basic Python Libraries

import os
import sys
import yaml
import time
import shutil
import atexit
import datetime
import subprocess

from dateutil.tz import tzutc
from kubernetes import client, config
from jinja2 import Environment, FileSystemLoader

# Create: Response, Program Exit

def exit_handler(): # always run this script after this file ends.

    config.load_kube_config()   # python can see the kube config now. now we can run API commands.

    v1 = client.CoreV1Api()   # initializing a tool to do kube stuff.

    pod_list = v1.list_namespaced_pod(namespace = params["namespace"])    # get all pods currently running (1 pod generates a single meep sim) 

    current_group = [ele.metadata.owner_references[0].name for ele in pod_list.items if(params["kill_tag"] in ele.metadata.name)]    # getting the name of the pod

    current_group = list(set(current_group))    # remove any duplicates

    for job_name in current_group:
        subprocess.run(["kubectl", "delete", "job", job_name])    # delete the kube job (a.k.a. pod)

    print("\nCleaned up any jobs that include tag : %s\n" % params["kill_tag"])   

# Create: Results Folders

def create_folder(path):

    if(os.path.exists(path)):
        shutil.rmtree(path)

    os.makedirs(path)

# Save: Template File

def save_file(path, data):

    data_file = open(path, "w")
   
    data_file.write(data) 

    data_file.close()

# Load: Template File

def load_file(path):

    data_file = open(path, "r")
    
    info = ""

    for line in data_file:
        info += line

    data_file.close()

    return info

# Run: Parallelized Physics Simulatiion

def run_generation(params):

    # Load job template

    template = load_file(params["path_template"])

    tag = params["path_template"].split("/")[-1]
    folder = params["path_template"].replace("/%s" % tag, "")
    environment = Environment(loader = FileSystemLoader(folder))
    template = environment.get_template(tag)

    # Launch Simulation Jobs

    create_folder(params["path_sim_job_files"])

    # - Begin data generation

    print("\nLaunching Data Generation Jobs\n")

    counter = params["start_group_id"]

    current_group = [] 

    file_list = [54, 72, 97, 98, 107, 117, 118, 129, 135, 156, 163, 167, 170, 184, 192, 198, 200, 201, 203, 205, 211, 216, 221, 222, 223, 224, 229, 242, 245, 248, 249, 252, 253, 254, 256, 257, 258, 260, 262, 263, 271, 274, 275, 311, 345, 378, 396, 445, 473, 506, 509, 511, 512, 513, 514, 523, 527, 528, 529, 538, 541, 546, 548, 549, 558, 567, 569, 573, 575, 579, 585, 590, 593, 601, 605, 607, 611, 612, 613, 617, 619, 629, 632, 633, 639, 640, 641, 644, 650, 651, 654, 655, 659, 665, 667, 669, 674, 675, 676, 678, 681, 682, 683, 684, 697, 702, 706, 707, 709, 713, 717, 718, 722, 724, 725, 726, 733, 734, 735, 744, 749, 752, 754, 763, 764, 766, 767, 768, 773, 774, 780, 782, 783, 786, 789, 790, 791, 793, 794, 795, 796, 797, 804, 813, 822, 823, 825, 826, 830, 835, 836, 838, 840, 845, 846, 852, 853, 854, 857, 862, 864, 866, 867, 870, 871, 873, 874, 875, 877, 881, 882, 883, 884, 887, 891, 894, 898, 903, 907, 908, 910, 911, 912, 927, 928, 930, 931, 936, 937, 938, 942, 943, 945, 946, 947, 953, 957, 958, 961, 962, 968, 969, 970, 971, 972, 973, 974, 979, 980, 981, 984, 990, 992, 993, 995, 1000, 1002, 1003, 1006, 1007, 1008, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1020, 1021, 1022, 1026, 1027, 1028, 1030, 1031, 1032, 1033, 1036, 1037, 1038, 1039, 1040, 1041, 1042, 1043, 1044, 1045, 1046, 1049, 1055, 1063, 1068, 1076, 1078, 1079, 1080, 1081, 1082, 1083, 1084, 1089, 1090, 1097, 1101, 1103, 1104, 1108, 1112, 1114, 1121, 1122, 1133, 1136, 1137, 1138, 1139, 1140, 1141, 1143, 1144, 1145, 1146, 1147, 1150, 1151, 1163, 1165, 1168, 1170, 1174, 1175, 1178, 1179, 1180, 1183, 1184, 1185, 1187, 1188, 1198, 1207, 1208, 1211, 1213, 1214, 1215, 1216, 1218, 1219, 1220, 1221, 1223, 1225, 1226, 1236, 1238, 1239, 1240, 1241, 1243, 1246, 1256, 1257, 1262, 1263, 1264, 1270, 1271, 1272, 1273, 1274, 1276, 1279, 1283, 1287, 1288, 1294, 1298, 1299, 1300, 1301, 1302, 1303, 1304, 1305, 1306, 1312, 1313, 1314, 1316, 1319, 1320, 1324, 1325, 1333, 1334, 1337, 1343, 1345, 1348, 1349, 1350, 1352, 1354, 1355, 1359, 1361, 1362, 1363, 1366, 1368, 1369, 1370, 1376, 1392, 1396, 1397, 1399, 1401, 1402, 1403, 1406, 1407, 1409, 1410, 1411, 1412, 1413, 1414, 1417, 1424, 1426, 1429, 1431, 1432, 1436, 1438, 1439, 1440, 1444, 1445, 1446, 1448, 1449, 1451, 1452, 1454, 1457, 1458, 1494, 1498, 1500, 1502, 1503, 1504, 1505, 1506, 1507, 1508, 1511, 1512, 1515, 1516, 1517, 1518, 1519, 1520, 1521, 1522, 1523, 1525, 1526, 1527, 1528, 1529, 1530, 1531, 1532, 1533, 1534, 1535, 1537, 1538, 1540, 1541, 1545, 1546, 1549, 1551, 1552, 1553, 1554, 1555, 1556, 1557, 1560, 1562, 1564, 1565, 1566, 1567, 1568, 1569, 1570, 1571, 1572, 1573, 1574, 1576, 1580, 1581, 1582, 1584, 1586, 1587, 1588, 1589, 1590, 1591, 1592, 1593, 1596, 1597, 1598, 1599, 1600, 1605, 1608, 1610, 1612, 1617, 1618, 1619, 1620, 1621, 1622, 1623, 1624, 1626, 1627, 1628, 1629, 1631, 1633, 1635, 1636, 1637, 1638, 1639, 1640, 1642, 1643, 1645, 1647, 1648, 1649, 1651, 1653, 1654, 1655, 1656, 1657, 1658, 1659, 1660, 1661, 1662, 1663, 1664, 1665, 1666, 1667, 1669, 1674, 1675, 1676, 1677, 1678, 1681, 1682, 1683, 1684, 1685, 1687, 1689, 1690, 1691, 1692, 1693, 1694, 1695, 1696, 1697, 1698, 1702, 1703, 1705, 1706, 1707, 1708, 1709, 1711, 1712, 1713, 1714, 1715, 1716, 1717, 1721, 1722, 1724, 1726, 1728, 1730, 1731, 1732, 1733, 1734, 1737, 1738, 1739, 1741, 1743, 1744, 1749, 1750, 1751, 1752, 1753, 1755, 1756, 1757, 1758, 1760, 1761, 1762, 1763, 1764, 1765, 1767, 1768, 1769, 1770, 1771, 1772, 1773, 1774, 1775, 1776, 1777, 1778, 1779, 1781, 1782, 1783, 1784, 1785, 1786, 1787, 1788, 1789, 1790, 1791, 1792, 1793, 1795, 1796, 1797, 1798, 1800, 1801, 1802, 1803, 1804, 1805, 1806, 1807, 1809, 1810, 1811, 1813, 1814, 1815, 1816, 1819, 1820, 1822, 1823, 1829, 1830, 1831, 1832, 1833, 1834, 1837, 1838, 1841, 1842, 1843, 1844, 1845, 1846, 1847, 1851, 1854, 1855, 1856, 1857, 1858, 1859, 1860, 1861, 1862, 1865, 1866, 1867, 1868, 1871, 1872, 1873, 1876, 1877, 1878, 1879, 1880, 1881, 1884, 1885, 1886, 1887, 1888, 1889, 1890, 1899, 1903, 1906, 1907, 1910, 1912, 1915, 1919, 1921, 1922, 1926, 1927, 1929, 1930, 1939, 1940, 1941, 1944, 1958, 1959, 1960, 1966, 1970, 1971, 1972, 1974, 1976, 1982, 1983, 1984, 1991, 2002, 2003, 2004, 2007, 2009, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2029, 2032, 2037, 2043, 2045, 2047, 2048, 2050, 2051, 2053, 2056, 2062, 2063, 2067, 2070, 2075, 2076, 2081, 2082, 2083, 2084, 2085, 2086, 2087, 2088, 2089, 2090, 2091, 2092, 2094, 2095, 2096, 2097, 2098, 2099, 2101, 2104, 2105, 2131, 2135, 2137, 2138, 2139, 2140, 2141, 2142, 2145, 2146, 2149, 2152, 2153, 2155, 2157, 2158, 2159, 2164, 2165, 2166, 2167, 2168, 2169, 2170, 2173, 2174, 2175, 2176, 2177, 2178, 2179, 2180, 2181, 2182, 2183, 2184, 2185, 2187, 2189, 2190, 2191, 2192, 2194, 2196, 2197, 2198, 2199, 2203, 2204, 2205, 2207, 2208, 2216, 2217, 2218, 2219, 2220, 2221, 2222, 2223, 2224, 2225, 2226, 2227, 2228, 2229, 2230, 2232, 2233, 2234, 2237, 2238, 2239, 2244, 2245, 2247, 2254, 2256, 2258, 2259, 2260, 2261, 2262, 2263, 2264, 2265, 2266, 2267, 2268, 2273, 2274, 2276, 2277, 2279, 2281, 2283, 2284, 2287, 2288, 2289, 2291, 2292, 2293, 2295, 2298, 2299, 2300, 2301, 2307, 2314, 2315, 2316, 2317, 2318, 2321, 2322, 2326, 2327, 2328, 2329, 2330, 2332, 2333, 2334, 2336, 2337, 2338, 2339, 2341, 2345, 2346, 2347, 2355, 2357, 2359, 2360, 2361, 2362, 2364, 2365, 2368, 2370, 2377, 2380, 2383, 2386, 2387, 2391, 2392, 2394, 2396, 2397, 2398, 2400, 2401, 2405, 2409, 2411, 2417, 2419, 2421, 2423, 2425, 2426, 2429, 2430, 2432, 2433, 2439, 2441, 2442, 2446, 2450, 2451, 2455, 2456, 2458, 2461, 2463, 2464, 2465, 2472, 2478, 2480, 2481, 2482, 2489, 2494, 2502, 2506, 2508, 2510, 2511, 2513, 2515, 2516, 2519, 2521, 2533, 2534, 2536, 2539, 2543, 2544, 2546, 2555, 2557, 2558, 2562, 2563, 2564, 2565, 2566, 2567, 2568, 2571, 2572, 2575, 2577, 2584, 2586, 2592, 2594, 2595, 2596, 2611, 2612, 2616, 2617, 2621, 2622, 2623, 2624, 2625, 2626, 2627, 2632, 2633, 2634, 2639, 2641, 2643, 2647, 2648, 2649, 2650, 2654, 2655, 2656, 2660, 2661, 2663, 2667, 2669, 2673, 2677, 2682, 2684, 2685, 2687, 2690, 2692, 2695, 2696, 2697, 2699, 2700, 2710, 2714, 2715, 2716, 2717, 2721, 2723, 2724, 2725, 2728, 2730, 2733, 2735, 2736, 2737, 2742, 2747, 2751, 2752, 2757, 2758, 2759, 2761, 2767, 2772, 2774, 2775, 2779, 2783, 2785, 2787, 2790, 2794, 2799, 2801, 2805, 2806, 2807, 2813, 2817, 2818, 2824, 2826, 2827, 2832, 2833, 2835, 2837, 2838, 2843, 2844, 2850, 2854, 2855, 2856, 2857, 2860, 2861, 2867, 2868, 2873, 2876, 2877, 2878, 2881, 2883, 2884, 2889, 2890, 2892, 2893, 2894, 2895, 2896, 2901, 2902, 2906, 2909, 2914, 2915, 2916, 2918, 2919, 2920, 2921, 2922, 2923, 2924, 2925, 2926, 2935, 2936, 2938, 2940, 2941, 2942, 2949, 2951, 2952, 2953, 2957, 2961, 2962, 2965, 2966, 2972, 2973, 3011, 3018, 3026, 3028, 3032, 3035, 3037, 3039, 3040, 3041, 3042, 3043, 3044, 3047, 3051, 3052, 3055, 3056, 3057, 3059, 3062, 3064, 3065, 3066, 3067, 3075, 3076, 3082, 3084, 3086, 3087, 3088, 3090, 3091, 3093, 3094, 3096, 3098, 3099, 3100, 3102, 3105, 3106, 3108, 3117, 3121, 3122, 3123, 3126, 3127, 3128, 3129, 3134, 3136, 3137, 3138, 3141, 3142, 3143, 3144, 3145, 3146, 3152, 3157, 3158, 3159, 3161, 3162, 3165, 3166, 3175, 3179, 3180, 3181, 3182, 3183, 3185, 3189, 3197, 3200, 3201, 3202, 3203, 3204, 3205, 3207, 3208, 3209, 3210, 3215, 3216, 3218, 3219, 3220, 3225, 3226, 3227, 3234, 3235, 3236, 3238, 3240, 3241, 3245, 3247, 3252, 3253, 3254, 3255, 3257, 3259, 3261, 3262, 3263, 3264, 3265, 3266, 3272, 3273, 3274, 3275, 3276, 3277, 3278, 3282, 3283, 3284, 3285, 3286, 3287, 3288, 3289, 3290, 3291, 3292, 3293, 3294, 3296, 3297, 3300, 3301, 3302, 3304, 3308, 3310, 3312, 3313, 3315, 3316, 3318, 3319, 3320, 3323, 3324, 3326, 3328, 3329, 3330, 3331, 3332, 3335, 3336, 3337, 3338, 3341, 3343, 3344, 3345, 3346, 3347, 3348, 3349, 3350, 3351, 3353, 3354, 3355, 3356, 3357, 3358, 3367, 3368, 3369, 3371, 3374, 3375, 3376, 3377, 3378, 3380, 3381, 3383, 3384, 3385, 3386, 3387, 3388, 3389, 3391, 3393, 3395, 3396, 3399, 3400, 3401, 3403, 3404, 3407, 3410, 3411, 3412, 3415, 3417, 3418, 3420, 3421, 3422, 3423, 3425, 3426, 3428, 3430, 3431, 3433, 3434, 3435, 3436, 3437, 3438, 3439, 3442, 3445, 3447, 3449, 3453, 3456, 3458, 3459, 3460, 3461, 3462, 3467, 3468, 3469, 3470, 3471, 3472, 3474, 3478, 3479, 3484, 3485, 3487, 3488, 3489, 3492, 3494, 3496, 3502, 3504, 3506, 3511, 3512, 3513, 3514, 3515, 3516, 3517, 3519, 3520, 3521, 3523, 3526, 3527, 3528, 3529, 3530, 3531, 3532, 3533, 3534, 3536, 3537, 3539, 3542, 3545, 3548, 3549, 3552, 3553, 3555, 3558, 3559, 3560, 3562, 3563, 3565, 3568, 3569, 3570, 3571, 3573, 3575, 3576, 3577, 3578, 3579, 3580, 3583, 3594, 3595, 3596, 3599, 3600, 3601, 3602, 3604, 3606, 3607, 3608, 3609, 3610, 3611, 3612, 3613, 3616, 3617, 3618, 3619, 3621, 3623, 3626, 3627, 3628, 3631, 3634, 3635, 3636, 3638, 3639, 3640, 3643, 3645, 3646, 3647, 3649, 3650, 3651, 3654, 3655, 3658, 3659, 3660, 3661, 3662, 3664, 3666, 3670, 3672, 3673, 3674, 3675, 3676, 3677, 3678, 3679, 3680, 3681, 3682, 3686, 3687, 3689, 3691, 3692, 3693, 3695, 3696, 3698, 3700, 3701, 3702, 3703, 3706, 3707, 3708, 3709, 3710, 3712, 3716, 3717, 3718, 3719, 3721, 3727, 3728, 3729, 3730, 3731, 3738, 3740, 3742, 3743, 3744, 3745, 3746, 3747, 3748, 3749, 3750, 3751, 3753, 3754, 3757, 3758, 3760, 3762, 3763, 3764, 3765, 3766, 3767, 3768, 3770, 3772, 3775, 3776, 3782, 3784, 3786, 3788, 3789, 3790, 3791, 3792, 3794, 3798, 3800, 3802, 3803, 3805, 3807, 3808, 3809, 3813, 3814, 3816, 3817, 3820, 3821, 3822, 3823, 3825, 3826, 3827, 3828, 3829, 3830, 3831, 3832, 3833, 3834, 3835, 3836, 3837, 3838, 3840, 3841, 3844, 3846, 3847, 3849, 3850, 3851, 3854, 3857, 3860, 3861, 3863, 3866, 3867, 3868, 3869, 3870, 3871, 3872, 3875, 3878, 3880, 3882, 3889, 3890, 3891, 3892, 3893, 3897, 3898, 3899, 3901, 3902, 3903, 3906, 3907, 3908, 3910, 3911, 3912, 3915, 3920, 3921, 3922, 3923, 3926, 3927, 3929, 3930, 3931, 3932, 3934, 3936, 3939, 3940, 3942, 3943, 3944, 3946, 3948, 3950, 3952, 3955, 3956, 3957, 3958, 3960, 3963, 3964, 3965, 3967, 3969, 3970, 3971, 3973, 3974, 3977, 3979, 3987, 4006, 4008, 4009, 4016, 4020, 4022, 4023, 4024, 4026, 4027, 4028, 4029, 4032, 4033, 4034, 4035, 4036, 4037, 4039, 4040, 4042, 4043, 4044, 4046, 4047, 4048, 4049, 4053, 4058, 4061, 4064, 4075, 4077, 4087, 4089, 4090, 4091, 4092, 4093, 4094, 4095, 4096, 4097, 4098, 4099, 4100, 4101, 4102, 4103, 4104, 4105, 4108, 4109, 4110, 4111, 4112, 4113, 4114, 4117, 4120, 4121, 4124, 4129, 4135, 4137, 4138, 4139, 4140, 4146, 4149, 4151, 4153, 4154, 4155, 4156, 4161, 4162, 4163, 4164, 4166, 4167, 4170, 4171, 4172, 4174, 4176, 4185, 4186, 4188, 4189, 4200, 4201, 4205, 4208, 4209, 4210, 4212, 4213, 4215, 4217, 4218, 4219, 4220, 4221, 4222, 4227, 4229, 4231, 4233, 4238, 4240, 4241, 4242, 4243, 4244, 4246, 4247, 4248, 4249, 4250, 4252, 4253, 4254, 4255, 4257, 4259, 4260, 4261, 4262, 4264, 4265, 4268, 4269, 4273, 4274, 4275, 4277, 4279, 4315, 4316, 4317, 4321, 4322, 4325, 4326, 4328, 4329, 4333, 4336, 4337, 4338, 4339, 4341, 4342, 4345, 4347, 4348, 4350, 4351, 4352, 4353, 4354, 4355, 4356, 4357, 4358, 4359, 4360, 4361, 4362, 4364, 4365, 4367, 4369, 4370, 4412, 4414, 4432, 4433, 4436, 4439, 4440, 4442, 4445, 4448, 4452, 4453, 4454, 4455, 4457, 4459, 4462, 4463, 4469, 4470, 4471, 4475, 4478, 4479, 4481, 4509, 4511, 4516, 4518, 4525, 4527, 4529, 4530, 4531, 4535, 4538, 4541, 4546, 4547, 4550, 4622, 4630, 4631, 4651, 4673, 4744, 4745]

    while(counter < params["num_sims"]):
        # -- Launch jobs if there is room in processing group

        if(len(current_group) < params["num_parallel_ops"]):

            num_to_launch = params["num_parallel_ops"] - len(current_group)

            for i in range(counter, counter + num_to_launch):
        
                if counter in file_list:

                    # --- Configure simulation job

                    job_name = "%s-%s" % (params["kill_tag"], str(counter).zfill(6))

                    current_group.append(job_name)

                    template_info = {"job_name": job_name, 
                                     "n_index": str(counter),
                                     "num_cpus": str(params["num_cpus_per_op"]),
                                     "num_mem_lim": str(params["num_mem_lim"]),
                                     "num_mem_req": str(params["num_mem_req"]),
                                     "path_out_sims": params["path_simulations"], "path_image": params["path_image"], "path_logs": params["path_logs"]}

                    filled_template = template.render(template_info)

                    path_job = os.path.join(params["path_sim_job_files"], job_name + ".yaml") 

                    if(sys.platform == "win32"):
                        path_job = path_job.replace("\\", "/").replace("/", "\\")

                    # --- Save simulation job file

                    save_file(path_job, filled_template)

                    # --- Launch simulation job

                    subprocess.run(["kubectl", "apply", "-f", path_job])

                counter += 1

        # -- Wait for a processes to finish

        else:

            k = 0
            check_time_min = 2
            wait_time_sec = 60

            while(len(current_group) == params["num_parallel_ops"]): 

                time.sleep(wait_time_sec)

                # --- Check progress every n minutes

                if(k % check_time_min == 0): 

                    # --- Gather kubernetes information

                    config.load_kube_config()
                    v1 = client.CoreV1Api()
                    pod_list = v1.list_namespaced_pod(namespace = params["namespace"], timeout_seconds = 300)
            
                    if(k == 0):
                        print()

                    pod_list = [item for item in pod_list.items if(params["kill_tag"] in item.metadata.name)]

                    pod_names = [item.metadata.name for item in pod_list]
                    pod_statuses = [item.status.phase for item in pod_list]

                    # --- Remove pods that have finished. Jobs and pods share the same name.
                    
                    pod_progress = [1 if(phase == "Succeeded" or phase == "Error") else 0 for phase in pod_statuses]

                    for i, (job_name, remove_flag) in enumerate(zip(current_group, pod_progress)):
                        if(remove_flag):
                            print()
                            #time.sleep(wait_time_sec)
                            subprocess.run(["kubectl", "delete", "job", job_name])
                            current_group.pop(i)
                            print()

                    print("Log: Elapsed Time = %s minutes, Group Size = %s, Total (In Progress) = %s / %s" % ((wait_time_sec * (k + 1)) / 60, len(current_group), counter, params["num_sims"]))

                    if(sum(pod_progress) > 0):
                        print("\nJobs Finished. Updating...\n")
                        break                    

                k += 1

    print("\nData Generation Complete\n")

# Validate: Configuration File

def load_config(argument):

    try:
        return yaml.load(open(argument), Loader = yaml.FullLoader) 

    except Exception as e:
        print("\nError: Loading YAML Configuration File") 
        print("\nSuggestion: Using YAML file? Check File For Errors\n")
        print(e)
        exit()        

# Parse: Command-line Arguments

def parse_args(all_args, tags = ["--", "-"]):

    all_args = all_args[1:]

    if(len(all_args) % 2 != 0):
        print("Argument '%s' not defined" % all_args[-1])
        exit()

    results = {}

    i = 0
    while(i < len(all_args) - 1):
        arg = all_args[i].lower()
        for current_tag in tags:
            if(current_tag in arg):
                arg = arg.replace(current_tag, "")                
        results[arg] = all_args[i + 1]
        i += 2

    return results

# Main: Load Configuration File

if __name__ == "__main__":

    args = parse_args(sys.argv)

    params = load_config(args["config"]) 

    #atexit.register(exit_handler)  # this is how we clean up jobs. 
    run_generation(params)
    
